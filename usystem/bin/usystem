#!/usr/bin/env bash

# bash strict mode
set -T # inherit DEBUG and RETURN trap for functions
set -C # prevent file overwrite by > &> <>
set -E # inherit -e
set -e # exit immediately on errors
set -u # exit on not assigned variables
set -o pipefail # exit on pipe failure


################################################################################
# global variable
################################################################################
declare -r CLI_VERSION='1.0.0';
declare -r CLI_NAME='usystem';
declare -r PS4='debug($LINENO) ${FUNCNAME[0]:+${FUNCNAME[0]}}(): ';
declare -r USYSTEM_ROOT_DIR=/volume1/@usystem
declare -r USYSTEM_WORK_DIR=${USYSTEM_ROOT_DIR}/usystem

# TODO: Upgrade to global option
declare -r BRANCH='main'


################################################################################
# functions
################################################################################
function _download() {
    if wget -L https://github.com/TimmerTech/synology-usystem/archive/main.tar.gz -O ${USYSTEM_ROOT_DIR}/usystem.tar.gz -o "${USYSTEM_WORK_DIR}"/log/usystem.download.log > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}


################################################################################
# commands
################################################################################
function repair_help() {
    echo $CLI_NAME repair
    echo
    echo Description:
    printf "%-4s%s\n" "" "Repair usystem, used after DSM upgrade or update."
    printf "%-4s%s\n" "" "This will mount and relink usystem to your Synology"
    exit 0
}

function repair_permissions() {
    if ! chmod -R 755 "${USYSTEM_WORK_DIR}"/bin; then
        return 1
    fi
    if ! chmod 755 "${USYSTEM_WORK_DIR}"/etc/certs; then
        return 1
    fi
    if ! chmod 755 "${USYSTEM_WORK_DIR}"/etc/account.conf; then
        return 1
    fi
    if ! chmod 755 "${USYSTEM_WORK_DIR}"/etc/http.header; then
        return 1
    fi
    if ! chmod -R 755 "${USYSTEM_WORK_DIR}"/etc/profile*; then
        return 1
    fi
    if ! chmod -R 755 "${USYSTEM_WORK_DIR}"/etc/rc.*; then
        return 1
    fi
    if ! chmod -R 700 "${USYSTEM_WORK_DIR}"/sbin; then
        return 1
    fi
    if ! chmod 755 "${USYSTEM_WORK_DIR}/log"; then
        return 1
    fi

    return 0
}

function repair() {
    printf "%s\n\n" "usystem repair"

    while [ ${#} -gt 0 ]; do
        case $1 in
            -h | --help | help )
                repair_help
            ;;
        esac
    done

    printf "%-32s " "Repairing rc.usystem ..."
    if cp "${USYSTEM_WORK_DIR}/etc/rc.usystem" /etc; then
        printf '[OK]\n'
    else
        printf '[FAILED]\n'
        exit 1
    fi

    printf "%-32s " "Repairing rc.local ..."
    if cp "${USYSTEM_WORK_DIR}/etc/rc.local" /etc; then
        printf '[OK]\n'
    else
        printf '[FAILED]\n'
        exit 1
    fi

    printf "%-32s " "Repairing permissions ..."
    if repair_permissions; then
        printf '[OK]\n'
    else
        printf '[FAILED]\n'
        exit 1
    fi

    exit 0;
}

function install_help() {
    echo $CLI_NAME install
    echo
    echo Description:
    printf "%-4s%s\n" "" "Repair usystem, used after DSM upgrade or update."
    printf "%-4s%s\n" "" "This will mount and relink usystem to your Synology"
    exit 0
}

function install() {
    while [ ${#} -gt 0 ]; do
        case $1 in
            -h | --help | help )
                install_help
            ;;
        esac
    done

    printf "%s\n\n" "usystem install"

    echo "Downloading..."
    _download
}

function backup_help() {
    echo $CLI_NAME backup
    echo
    echo Description:
    printf "%-4s%s\n" "" "Create backup of usystem."
    exit 0
}

function backup() {
    while [ ${#} -gt 0 ]; do
        case $1 in
            -h | --help | help )
                backup_help
            ;;
        esac
    done

    rm -f "${USYSTEM_ROOT_DIR}"/usystem.tar.gz
    printf "%-32s" "Creating backup ..."
    if tar -czf "${USYSTEM_ROOT_DIR}/backup/usystem.backup.$(date +'%Y%m%d-%H%M%S').tar.gz" --exclude usystem/tmp -C "${USYSTEM_ROOT_DIR}" usystem/; then
        printf '[OK]\n'
    else
        printf '[FAILED]\n'
        echo "ERROR: Failed to create backup"
        exit 1
    fi
}

function upgrade_help() {
    echo $CLI_NAME upgrade
    echo
    echo Description:
    printf "%-4s%s\n" "" "Upgrade to latest version of usystem."
    exit 0
}

function upgrade() {
    while [ ${#} -gt 0 ]; do
        case $1 in
            -h | --help | help )
                upgrade_help
            ;;
        esac
    done

    # Create backup
    $(basename "${0}") backup

    printf "%-32s" "Downloading upgrade ..."
    if _download; then
        printf '[OK]\n'
    else
        printf '[FAILED]\n'
        echo "ERROR: Failed to download; see log: /usys/log/usystem.download.log"
        exit 1
    fi

    printf "%-32s" "Upgrading ..."
    if tar -xzf "${USYSTEM_ROOT_DIR}"/usystem.tar.gz --strip-components=1 -C "${USYSTEM_ROOT_DIR}"; then
        printf '[OK]\n'
    else
        printf '[FAILED]\n'
        # TODO: REVERT BACKUP
    fi
}

function main_help() {
    echo $CLI_NAME $CLI_VERSION
    echo
    echo Usage:
    printf "%-4s%s\n" "" "$CLI_NAME command [options]"
    printf "%-4s%s\n" "" "$CLI_NAME command help"
    echo
    echo Global:
    printf "%-4s%-23s %s\n" "" "help" "show help";
    printf "%-4s%-23s %s\n" "" "version" "show version";
    echo
    echo Commands:
    printf "%-4s%-23s %s\n" "" "backup" "Backup usystem";
    printf "%-4s%-23s %s\n" "" "install" "Install usystem";
    printf "%-4s%-23s %s\n" "" "upgrade" "Upgrade usystem";
    printf "%-4s%-23s %s\n" "" "repair" "Repair usystem";

    exit "${1:-0}";
}

function version() {
    echo $CLI_NAME $CLI_VERSION;
    exit 0
}

function main() {
    if (( ${#} == 0 )); then
        main_help 0;
    fi

    case ${1} in
        help )
            main_help 0;
        ;;
        version )
            version
        ;;
        backup | install | upgrade | repair )
            $1 "${@:2}";
        ;;
        * )
            echo "unknown command: $1";
            main_help 1;
        ;;
    esac
}

main "$@";
